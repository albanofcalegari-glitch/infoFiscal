<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consulta Factura Cliente</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='estudio.css') }}">
</head>
<body>
    <div class="header" style="position:relative;">
        <div style="display:flex; align-items:center; justify-content:space-between;">
            <div style="min-width:140px;">
                <a href="/home" style="color:#fff; text-decoration:none; font-weight:700; font-size:1.15em; padding:4px 10px; border-radius:4px;">InfoFiscal</a>
            </div>
            <div style="flex:1;"></div>
            <div style="position:relative;">
                <div class="user-menu" style="display:inline-block; position:relative;">
                    <button id="userBtn" style="background:none; border:none; cursor:pointer; font-size:1em; padding:0; margin:0;">
                        <span style="vertical-align:middle; font-size:1.1em;">üë§</span>
                    </button>
                    <div id="userDropdown" style="display:none; position:absolute; right:0; background:#fff; border:1px solid #bfc9d1; border-radius:5px; box-shadow:0 2px 8px rgba(26,53,94,0.10); min-width:120px; z-index:10; font-size:0.95em;">
                        <div style="padding:7px 12px; border-bottom:1px solid #eee; color:#1a355e; font-weight:500;">{{ usuario }}</div>
                        <a href="{{ url_for('logout') }}" style="display:block; padding:7px 12px; color:#c00; text-decoration:none; font-weight:500;">Cerrar sesi√≥n</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    const userBtn = document.getElementById('userBtn');
    const userDropdown = document.getElementById('userDropdown');
    userBtn.addEventListener('mouseenter', () => {
        userDropdown.style.display = 'block';
    });
    userBtn.addEventListener('mouseleave', () => {
        setTimeout(() => { if (!userDropdown.matches(':hover')) userDropdown.style.display = 'none'; }, 200);
    });
    userDropdown.addEventListener('mouseleave', () => {
        userDropdown.style.display = 'none';
    });
    userDropdown.addEventListener('mouseenter', () => {
        userDropdown.style.display = 'block';
    });
    </script>
    <div class="main-container" style="margin-top:40px; max-width:98vw;">
        <h2>Datos del cliente seleccionado</h2>
        <div style="overflow-x:auto; width:100%;">
            <table style="min-width:700px; width:100%; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(26,53,94,0.08);">
                <thead>
                    <tr style="background:#f3f6fa; color:#1a355e;">
                        <th style="padding:10px 8px; border-bottom:1px solid #bfc9d1;">Tipo Doc</th>
                        <th style="padding:10px 8px; border-bottom:1px solid #bfc9d1;">Nro Doc</th>
                        <th style="padding:10px 8px; border-bottom:1px solid #bfc9d1;">Apellido</th>
                        <th style="padding:10px 8px; border-bottom:1px solid #bfc9d1;">Nombres</th>
                        <th style="padding:10px 8px; border-bottom:1px solid #bfc9d1;">CUIT</th>
                        <th style="padding:10px 8px; border-bottom:1px solid #bfc9d1;">Fecha Nac.</th>
                        <th style="padding:10px 8px; border-bottom:1px solid #bfc9d1;">Condici√≥n IVA</th>
                        <th style="padding:10px 8px; border-bottom:1px solid #bfc9d1;">Categor√≠a Monotributo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding:8px 6px; border-bottom:1px solid #eee;">{{ cliente.tipoDocumento }}</td>
                        <td style="padding:8px 6px; border-bottom:1px solid #eee;">{{ cliente.nroDocumento }}</td>
                        <td style="padding:8px 6px; border-bottom:1px solid #eee;">{{ cliente.apellido }}</td>
                        <td style="padding:8px 6px; border-bottom:1px solid #eee;">{{ cliente.nombres }}</td>
                        <td style="padding:8px 6px; border-bottom:1px solid #eee;">{{ cliente.CUIT or cliente.cuit }}</td>
                        <td style="padding:8px 6px; border-bottom:1px solid #eee;">{{ cliente.fechaNacimiento }}</td>
                        <td style="padding:8px 6px; border-bottom:1px solid #eee;">{{ cliente.condicionIVA }}</td>
                        <td style="padding:8px 6px; border-bottom:1px solid #eee;">{{ cliente.categoriaMonotriibuto }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Controles de configuraci√≥n para descarga -->
        <div style="margin-top:24px; padding:20px; background:#f8f9fa; border-radius:8px; border:1px solid #dee2e6;">
            <h4 style="margin:0 0 16px 0; color:#495057; font-size:1rem;">Configuraci√≥n de Descarga</h4>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                    <label for="fechaDesde" style="display:block; margin-bottom:4px; font-weight:600; color:#6c757d; font-size:0.9rem;">Desde:</label>
                    <input type="date" id="fechaDesde" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;">
                </div>
                <div>
                    <label for="fechaHasta" style="display:block; margin-bottom:4px; font-weight:600; color:#6c757d; font-size:0.9rem;">Hasta:</label>
                    <input type="date" id="fechaHasta" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;">
                </div>
            </div>
            
            <div style="margin-bottom:16px;">
                <label for="tiposIncluir" style="display:block; margin-bottom:4px; font-weight:600; color:#6c757d; font-size:0.9rem;">Tipos a incluir (opcional):</label>
                <input type="text" id="tiposIncluir" placeholder="Ej: 1,6,11 (Facturas A,B,C)" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;">
                <small style="color:#6c757d; font-size:0.8rem;">Deje vac√≠o para incluir todos los tipos</small>
            </div>
        </div>
        
        <div style="margin-top:20px; display:flex; justify-content:center;">
            <button id="descargarFacturasBtn" style="height:48px; min-width:200px; font-size:1rem; font-weight:700; border-radius:6px; background:#1a355e; color:#fff; border:none; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                üì• Descargar Facturas AFIP
            </button>
        </div>
        <script>
        // Inicializar fechas por defecto (√∫ltimo mes)
        window.addEventListener('DOMContentLoaded', function() {
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(hoy.getMonth() - 1);
            
            document.getElementById('fechaHasta').value = hoy.toISOString().split('T')[0];
            document.getElementById('fechaDesde').value = haceUnMes.toISOString().split('T')[0];
        });
        
        document.getElementById('descargarFacturasBtn').onclick = function() {
            const cuit = '{{ cliente.CUIT or cliente.cuit }}';
            const btn = this;
            
            // Obtener valores de los campos
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;
            const tiposIncluir = document.getElementById('tiposIncluir').value.trim();
            
            // Validar fechas
            if (!fechaDesde || !fechaHasta) {
                alert('‚ö†Ô∏è Por favor, complete las fechas desde y hasta');
                return;
            }
            
            if (new Date(fechaDesde) > new Date(fechaHasta)) {
                alert('‚ö†Ô∏è La fecha "desde" no puede ser posterior a la fecha "hasta"');
                return;
            }
            
            // Construir URL con par√°metros
            let url = `/descargar-facturas?cuit=${encodeURIComponent(cuit)}&desde=${fechaDesde}&hasta=${fechaHasta}`;
            
            if (tiposIncluir) {
                url += `&incluir_tipos=${encodeURIComponent(tiposIncluir)}`;
            }
            
            // Mostrar estado de carga
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Consultando AFIP...';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = 'üì• Descargar Facturas AFIP';
                    
                    if (data.success) {
                        // Determinar el √≠cono seg√∫n el tipo de resultado
                        let icono = '‚úÖ';
                        if (data.status === 'sin_facturas') {
                            icono = '‚ÑπÔ∏è';
                        } else if (data.tipo_alerta === 'warning') {
                            icono = '‚ö†Ô∏è';
                        } else if (data.tipo_alerta === 'info') {
                            icono = '‚ÑπÔ∏è';
                        }
                        
                        let mensaje = `${icono} ${data.user_message || 'Proceso completado'}\n\n`;
                        mensaje += `CUIT: ${cuit}\n`;
                        
                        // Mostrar informaci√≥n del per√≠odo consultado
                        if (data.fecha_desde && data.fecha_hasta) {
                            mensaje += `Per√≠odo: ${data.fecha_desde} a ${data.fecha_hasta}\n`;
                        }
                        
                        // Mostrar cantidad de facturas encontradas
                        if (data.total_encontrados !== undefined) {
                            mensaje += `Facturas encontradas: ${data.total_encontrados}\n`;
                        }
                        
                        // Mostrar archivos generados si hay facturas
                        if (data.status === 'ok' && data.total_encontrados > 0 && data.archivos_generados) {
                            mensaje += `\nüìÅ Archivos generados:\n`;
                            mensaje += `‚Ä¢ CSV: ${data.archivos_generados.csv}\n`;
                            mensaje += `‚Ä¢ JSON: ${data.archivos_generados.json}\n`;
                            
                            // Mostrar resumen si est√° disponible
                            if (data.resumen) {
                                mensaje += `\nüìä Resumen:\n`;
                                mensaje += `‚Ä¢ Cantidad: ${data.resumen.cantidad_total} comprobantes\n`;
                                mensaje += `‚Ä¢ Per√≠odo: ${data.resumen.periodo}\n`;
                                if (data.resumen.tipos_consultados && data.resumen.tipos_consultados !== 'Todos') {
                                    mensaje += `‚Ä¢ Tipos incluidos: ${data.resumen.tipos_consultados}\n`;
                                }
                                if (data.resumen.tipos_excluidos && data.resumen.tipos_excluidos !== 'Ninguno') {
                                    mensaje += `‚Ä¢ Tipos excluidos: ${data.resumen.tipos_excluidos}\n`;
                                }
                            }
                        } else if (data.accion_sugerida) {
                            mensaje += `\n${data.accion_sugerida}`;
                        }
                        
                        alert(mensaje);
                    } else {
                        // Error - mostrar detalles del problema
                        let mensaje = `‚ùå Error al descargar facturas\n\n`;
                        mensaje += `CUIT: ${cuit}\n`;
                        mensaje += `Error: ${data.error}\n`;
                        if (data.detalle) {
                            mensaje += `\nDetalles: ${data.detalle}\n`;
                        }
                        
                        // Agregar instrucciones seg√∫n el tipo de error
                        if (data.error.includes('certificado') || data.error.includes('autenticaci√≥n')) {
                            mensaje += `\nüìã PASOS PARA SOLUCIONAR:\n`;
                            mensaje += `1. Ir a www.afip.gob.ar ‚Üí Mi AFIP\n`;
                            mensaje += `2. Verificar certificados en 'Administrador de Relaciones'\n`;
                            mensaje += `3. Activar servicios web WSAA y WSFE\n`;
                            mensaje += `4. Confirmar delegaciones para CUIT ${cuit}`;
                        }
                        
                        alert(mensaje);
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = 'üì• Descargar Facturas AFIP';
                    
                    alert(`‚ùå Error de conexi√≥n\n\n` +
                          `No se pudo conectar con el servidor.\n` +
                          `Verifique su conexi√≥n a internet y vuelva a intentar.\n\n` +
                          `Error t√©cnico: ${error.message || error}`);
                });
        };
        </script>
    </div>
</body>
</html>
